<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Steamboxd</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="p-4">
  <div class="container">
    <div class="mb-4 d-flex justify-content-between align-items-center">
      <h1 class="mb-0">Steamboxd</h1>
      <button class="btn btn-outline-danger btn-sm" onclick="logout()">Sair</button>
    </div>

    <h2 class="mb-4">Adicionar Jogo</h2>
    <form id="form-jogo" class="mb-5">
      <input type="text" id="nome" placeholder="Nome do Jogo" class="form-control mb-2" required />
      <input type="number" step="0.1" id="nota" placeholder="Nota" class="form-control mb-2" />
      <input type="text" id="status" placeholder="Status" class="form-control mb-2" />
      <textarea id="comentario" placeholder="Coment√°rio" class="form-control mb-2"></textarea>
      <button type="submit" class="btn btn-primary">Enviar</button>
    </form>

    <div class="mb-4">
      <h4>Filtros</h4>
      <input type="text" id="filtro-nome" placeholder="Buscar por nome" class="form-control w-auto d-inline-block me-2 mb-2" />

      <select id="filtro-status" class="form-select w-auto d-inline-block me-2">
        <option value="">Todos os status</option>
        <option value="quero jogar">Quero jogar</option>
        <option value="jogando">Jogando</option>
        <option value="jogado">Jogado</option>
      </select>

      <select id="filtro-nota" class="form-select w-auto d-inline-block me-2">
        <option value="">Todas as notas</option>
        <option value="9">Nota ‚â• 9</option>
        <option value="8">Nota ‚â• 8</option>
        <option value="7">Nota ‚â• 7</option>
      </select>

      <div class="form-check form-check-inline mb-2">
      <input class="form-check-input" type="checkbox" id="filtro-favorito" />
      <label class="form-check-label" for="filtro-favorito">Somente favoritos</label>

</div>
      <button class="btn btn-secondary btn-sm" onclick="limparFiltros()">Limpar Filtros</button>
    </div>

    <h2>Jogos Salvos</h2>
    <ul id="lista-jogos" class="list-unstyled"></ul>
  </div>

  <!-- Modal de Edi√ß√£o -->
  <div class="modal fade" id="modalEditar" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Editar Jogo</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <input type="number" id="modal-nota" class="form-control mb-2" placeholder="Nova Nota" />
          <input type="text" id="modal-status" class="form-control mb-2" placeholder="Novo Status" />
          <textarea id="modal-comentario" class="form-control" placeholder="Novo Coment√°rio"></textarea>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-primary" onclick="confirmarEdicao()">Salvar</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const form = document.getElementById("form-jogo");
    const lista = document.getElementById("lista-jogos");
    const filtroStatus = document.getElementById("filtro-status");
    const filtroNota = document.getElementById("filtro-nota");
    const filtroNome = document.getElementById("filtro-nome");
    let todosOsJogos = [];
    let jogoAtualParaEditar = "";

    async function verificarLogin() {
      const res = await fetch("http://localhost:5000/usuario-logado", { credentials: "include" });
      const dados = await res.json();
      if (!dados.logado) {
        window.location.href = "login.html";
      } else {
        atualizarLista();
      }
    }

    async function logout() {
      await fetch("http://localhost:5000/logout", { credentials: "include" });
      window.location.href = "login.html";
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const dados = {
        nome: document.getElementById("nome").value,
        nota: parseFloat(document.getElementById("nota").value),
        status: document.getElementById("status").value,
        comentario: document.getElementById("comentario").value
      };

      const res = await fetch("http://localhost:5000/jogos", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify(dados)
      });

      const resp = await res.json();
      alert(resp.mensagem || resp.erro);
      atualizarLista();
    });

    filtroStatus.addEventListener("change", exibirFiltrados);
    filtroNota.addEventListener("change", exibirFiltrados);
    filtroNome.addEventListener("input", exibirFiltrados);
    document.getElementById("filtro-favorito").addEventListener("change", exibirFiltrados);

    function limparFiltros() {
      filtroStatus.value = "";
      filtroNota.value = "";
      filtroNome.value = "";
      exibirFiltrados();
    }

    async function atualizarLista() {
      const res = await fetch("http://localhost:5000/jogos", { credentials: "include" });
      const jogos = await res.json();
      todosOsJogos = Array.isArray(jogos) ? jogos : [];
      exibirFiltrados();
    }

    function exibirFiltrados() {
      const statusSelecionado = filtroStatus.value;
      const notaSelecionada = parseFloat(filtroNota.value);
      const nomeBusca = filtroNome.value.toLowerCase();

      const somenteFavoritos = document.getElementById("filtro-favorito").checked;

      const jogosFiltrados = todosOsJogos.filter(jogo => {
        const statusOk =
          !statusSelecionado ||
          (statusSelecionado === "favorito" && jogo.favorito) ||
          jogo.status === statusSelecionado;

        const notaOk = isNaN(notaSelecionada) || (jogo.nota >= notaSelecionada);
        const nomeOk = !nomeBusca || jogo.nome.toLowerCase().includes(nomeBusca);
        const favoritoOk = !somenteFavoritos || jogo.favorito;

        return statusOk && notaOk && nomeOk && favoritoOk;
      });

      lista.innerHTML = "";
      jogosFiltrados.forEach(jogo => {
        const capaUrl = jogo.capa_id
          ? `https://images.igdb.com/igdb/image/upload/t_cover_big/${jogo.capa_id}.jpg`
          : null;

        const favoritoIcone = jogo.favorito ? "‚≠ê" : "‚òÜ";

        const li = document.createElement("li");
        li.className = "mb-4";
        li.innerHTML = `
          ${capaUrl ? `<img src="${capaUrl}" alt="Capa de ${jogo.nome}" style="height:150px;"><br>` : ""}
          <strong>${jogo.nome}</strong>
          <button class="btn btn-sm btn-outline-warning ms-2" onclick="toggleFavorito('${jogo.nome}', ${jogo.favorito})">${favoritoIcone}</button><br>
          Nota: ${jogo.nota} ‚Äî ${jogo.status}<br>
          Coment√°rio: ${jogo.comentario}<br>
          <em>${jogo.generos || "Sem g√™nero"} | ${jogo.plataformas || "Sem plataforma"}</em><br>
          ${jogo.data_lancamento ? `Lan√ßamento: ${new Date(jogo.data_lancamento * 1000).toLocaleDateString()}` : ""}
          <p>${jogo.resumo || "Sem resumo dispon√≠vel."}</p>
          <button class="btn btn-sm btn-warning me-2" onclick="abrirModalEditar('${jogo.nome}', ${jogo.nota}, '${jogo.status}', '${jogo.comentario.replace(/'/g, "&#39;")}')"
            data-bs-toggle="modal" data-bs-target="#modalEditar">
            ‚úèÔ∏è Editar
          </button>
          <button class="btn btn-sm btn-danger" onclick="removerJogo('${jogo.nome}')">üóë Remover</button>
          <hr>
        `;
        lista.appendChild(li);
      });
    }

    async function toggleFavorito(nome, atual) {
      const novoValor = atual ? 0 : 1;
      const res = await fetch(`http://localhost:5000/jogos/favorito/${encodeURIComponent(nome)}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({ favorito: novoValor })
      });

      const resp = await res.json();
      alert(resp.mensagem || resp.erro);
      atualizarLista();
    }


    function abrirModalEditar(nome, nota, status, comentario) {
      jogoAtualParaEditar = nome;
      document.getElementById("modal-nota").value = nota;
      document.getElementById("modal-status").value = status;
      document.getElementById("modal-comentario").value = comentario;
    }

    async function confirmarEdicao() {
      const nota = parseFloat(document.getElementById("modal-nota").value);
      const status = document.getElementById("modal-status").value;
      const comentario = document.getElementById("modal-comentario").value;

      const res = await fetch(`http://localhost:5000/jogos/${encodeURIComponent(jogoAtualParaEditar)}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        credentials: "include",
        body: JSON.stringify({ nota, status, comentario })
      });

      const resp = await res.json();
      alert(resp.mensagem || resp.erro);
      const modal = bootstrap.Modal.getInstance(document.getElementById("modalEditar"));
      modal.hide();
      atualizarLista();
    }

    verificarLogin();
  </script>
</body>
</html>
